<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Turismo en Granada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

    <style>
        body {
            display: flex;
            flex-direction: column;
        }

        #container2 {
            width: 80%;
            margin: 0 auto;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        select, #filters-container2 {
            width: 100%;
            margin-bottom: 20px;
        }
        select {
            padding: 8px;
        }
        #chart-container2 {
            width: 100%;
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        svg {
            width: 80%;
            height: 100%;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        .legend {
            font-size: 12px;
        }
        .legend-item {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .legend-item:hover {
            opacity: 0.5;
        }
        .filter-value-button {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .filter-container2 {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .filter-controls {
            display: flex;
            flex-direction: column;
        }
        .filter-value-container2 {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        .filter-none-button {
            margin-top: 5px;
        }
        .legend-box {
            width: 80%;
            background-color: lightgray;
            border: 1px solid black;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            text-align: left;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        #info-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            margin-left: 20px;
        }
    
        .info-icon {
            cursor: pointer;
            margin-right: 10px;
        }
    
        .info-message {
            display: none;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
        }
    
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark p-md-3 nav-underline" style="position: absolute; width: 100%; z-index: 1000;">
        <div class="container">
          <a href="index.html" class="logo navar-brand d-flex align-items-center">
            <h1 class="sitename">ExploraGranada</h1> <span>.</span>
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
  
          <div class="collapse navbar-collapse" id="navbarNav">
            <div class="mx-auto"></div>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link text-white" href="index.html">Inicio</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="index.html#about">About</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="index.html#analisis">Analisis</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#">Contacto</a>
              </li>
            </ul>
          </div>
        </div>
    </nav>
    <!-- Banner Carousel -->
  <div id="bannerCarousel" class="carousel slide banner-carousel mb-5" data-bs-ride="carousel">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="img/alhambra.jpg" class="d-block w-100" alt="Alhambra">
      </div>
      <div class="carousel-item">
        <img src="img/paseo-tristes.jpg" class="d-block w-100" alt="Another Image">
      </div>
      <div class="carousel-item">
        <img src="img/vistas-ciudad-de-granada.jpg" class="d-block w-100" alt="Yet Another Image">
      </div>
    </div>
    <div class="carousel-caption">
      <h2>Bienvenidos a Granada</h2>
      <p>Granada es una ciudad en la región de Andalucía en el sur de España, en la ladera de las montañas de la Sierra Nevada. Es famosa por sus grandes ejemplos de arquitectura medieval que datan de la ocupación de los moros, en particular, la Alhambra.</p>
      <a href="#get-started" class="btn btn-custom btn-lg">Conoce más</a>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#bannerCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#bannerCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

  <div id="container2">
    <h1>Evolución Temporal del Turismo en Granada</h1>
    <br>
    <p>Esta visualización le permite explorar la evolución temporal de diversos aspectos del turismo en Granada. Para comenzar, seleccione el tipo de gráfico que desea utilizar: líneas para visualizar tendencias a lo largo del tiempo o barras para comparar valores entre diferentes periodos.</p>
    <p>A continuación, seleccione las variables que desea representar en los ejes X e Y. Por ejemplo, puede elegir representar el número de visitantes en el eje Y y la fecha en el eje X para ver cómo ha fluctuado la cantidad de turistas a lo largo del tiempo.</p>
    <p>Además, puede aplicar filtros para explorar segmentos específicos de datos. Por ejemplo, puede filtrar por tipo de turista o cualquier otra variable disponible en el conjunto de datos. Los filtros le permiten obtener una perspectiva más detallada de la evolución del turismo según sus criterios específicos.</p>
    <p>Al hacer clic en los elementos de la gráfica, puede obtener más detalles sobre los datos representados. Esto le permite explorar puntos específicos y comprender mejor las tendencias y patrones presentes en los datos.</p>
    <br> <br>
    <h2>Seleccionar tipo de gráfico:</h2>
    <select id="chart-type-selector">
        <option value="line">Líneas</option>
        <option value="bar">Barras</option>
    </select>

    <div id="x-variable-container">
        <h2>Seleccionar variable para eje X:</h2>
        <select id="x-variable-selector">
            <!-- Opciones generadas automáticamente -->
        </select>
    </div>

    <div id="y-variable-container">
        <h2>Seleccionar variable para eje Y:</h2>
        <select id="y-variable-selector">
            <!-- Opciones generadas automáticamente -->
        </select>
    </div>

    <div id="filters-container">
        <h2>Seleccionar filtros:</h2>
        <div id="filter-controls">
            <!-- Controles de filtros generados automáticamente -->
        </div>
        <button id="add-filter-button">Añadir filtro</button>
    </div>

    <div id="info-container">
        <i class="bi bi-info-circle info-icon"></i>
        <div class="info-message">Cuando se selecciona 'días de antelación' como variable del eje X, los filtros disponibles son 'tipo' y 'pax'. Además, para una correcta
            visualización, se recomienda que solo se introduzcan un valor por cada variable de filtro. Es decir, seleccionar 'tipo' = Apartamentos y 'pax' = 2. De esta manera 
            se verá una evolución correcta de las fechas estudiadas.
        </div>
    </div>

    <div id="chart-container"></div>
    <div id="legend-container"></div>
</div>
<script>
    d3.csv("../graficas/datos.csv").then(function(data) {
        const parseDate = d3.timeParse("%Y-%m-%d");
        data.forEach(d => {
            if (d['check-in']) {
                d['check-in'] = parseDate(d['check-in']);
            }
        });

        d3.csv("../graficas/precios.csv").then(function(precioData) {
            precioData.forEach(d => {
                if (d['check-in']) {
                    d['check-in'] = parseDate(d['check-in']);
                }
                for (let key in d) {
                    if (key !== 'check-in' && key !== 'tipo' && key !== 'pax') {
                        d[key] = +d[key];  // Convertir a número
                    }
                }
            });

            const variables = Object.keys(data[0]);
            const dias_anticipacion = [1, 6, 8, 13, 15, 20, 22, 27];

            const chartTypeSelector = document.getElementById("chart-type-selector");
            const xVariableSelector = document.getElementById("x-variable-selector");
            const yVariableSelector = document.getElementById("y-variable-selector");
            const filterControls = document.getElementById("filter-controls");
            const addFilterButton = document.getElementById("add-filter-button");
            const infoIcon = document.querySelector(".info-icon");
            const infoMessage = document.querySelector(".info-message");

            infoIcon.addEventListener("click", () => {
                if (infoMessage.style.display === "block") {
                    infoMessage.style.display = "none";
                } else {
                    infoMessage.style.display = "block";
                }
            });

            // Clear any existing options in the x-variable selector
            xVariableSelector.innerHTML = "";

            // Add the 'check-in' option
            const checkInOption = document.createElement("option");
            checkInOption.value = "check-in";
            checkInOption.textContent = "check-in";
            xVariableSelector.appendChild(checkInOption);

            // Add the 'dias de antelacion' option
            const diasAntelacionOption = document.createElement("option");
            diasAntelacionOption.value = "dias de antelacion";
            diasAntelacionOption.textContent = "días de antelación";
            xVariableSelector.appendChild(diasAntelacionOption);

            variables.forEach(variable => {
                const yOption = document.createElement("option");
                yOption.value = variable;
                yOption.textContent = variable;
                yVariableSelector.appendChild(yOption);
            });

            function createFilterControl() {
                const filterContainer = document.createElement("div");
                filterContainer.className = "filter-container";

                const filterVariableSelector = document.createElement("select");
                filterVariableSelector.className = "filter-variable-selector";
                filterVariableSelector.innerHTML = `<option value="">Ninguno</option>`;
                variables.forEach(variable => {
                    const filterOption = document.createElement("option");
                    filterOption.value = variable;
                    filterOption.textContent = variable;
                    filterVariableSelector.appendChild(filterOption);
                });

                const filterValueContainer = document.createElement("div");
                filterValueContainer.className = "filter-value-container";

                const noneButton = document.createElement("button");
                noneButton.className = "filter-none-button";
                noneButton.textContent = "Ninguno";
                noneButton.addEventListener("click", () => {
                    filterValueContainer.querySelectorAll('button').forEach(button => {
                        button.classList.remove('selected');
                        button.style.border = "";
                        button.style.color = "";
                    });
                    updateChart();
                });

                filterVariableSelector.addEventListener("change", () => {
                    updateFilterValues(filterVariableSelector, filterValueContainer);
                });

                filterContainer.appendChild(filterVariableSelector);
                filterContainer.appendChild(filterValueContainer);
                filterContainer.appendChild(noneButton);
                filterControls.appendChild(filterContainer);
            }

            function updateFilterValues(filterVariableSelector, filterValueContainer) {
                const filterVariable = filterVariableSelector.value;
                const uniqueValues = filterVariable ? Array.from(new Set(data.map(d => d[filterVariable]))) : [];

                filterValueContainer.innerHTML = '';
                uniqueValues.forEach(value => {
                    const filterValueButton = document.createElement("button");
                    filterValueButton.className = "filter-value-button";
                    filterValueButton.textContent = value;
                    filterValueButton.addEventListener("click", () => {
                        filterValueButton.classList.toggle('selected');
                        if (filterValueButton.classList.contains('selected')) {
                            filterValueButton.style.border = "2px solid red";
                            filterValueButton.style.color = "red";
                        } else {
                            filterValueButton.style.border = "";
                            filterValueButton.style.color = "";
                        }
                        updateChart();
                    });
                    filterValueContainer.appendChild(filterValueButton);
                });
            }

            function getFilters() {
                const filters = {};
                document.querySelectorAll(".filter-container").forEach(container => {
                    const variable = container.querySelector(".filter-variable-selector").value;
                    const selectedValues = Array.from(container.querySelectorAll(".filter-value-container button.selected")).map(button => button.textContent);
                    if (variable && selectedValues.length > 0) {
                        filters[variable] = selectedValues;
                    }
                });
                return filters;
            }

            function splitDataIntoSeries(data, seriesLength) {
                const series = [];
                for (let i = 0; i < data.length; i += seriesLength) {
                    series.push(data.slice(i, i + seriesLength));
                }
                return series;
            }

            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

            function updateChart() {
                const chartType = chartTypeSelector.value;
                const xVariable = xVariableSelector.value;
                const yVariable = yVariableSelector.value;
                const filters = getFilters();

                let filteredData = data;
                if (xVariable === "dias de antelacion" && yVariable === "precio") {
                    filteredData = precioData;
                }

                const filteredDataFinal = filteredData.filter(d => {
                    return Object.keys(filters).every(filter => filters[filter].includes(d[filter])) && d[xVariable] !== null && d[yVariable] !== null;
                });

                const margin = { top: 20, right: 30, bottom: 60, left: 80 };
                const width = document.getElementById("container2").clientWidth * 0.7 - margin.left - margin.right;
                const height = 600 - margin.top - margin.bottom;
                const innerWidth = width;
                const innerHeight = height;

                d3.select("#chart-container").selectAll("*").remove();

                const svg = d3.select("#chart-container")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                if (xVariable === "dias de antelacion") {
                    const columnsToPlot = [1, 6, 8, 13, 15, 20, 22, 27];
                    const dfTransposed = {};

                    filteredDataFinal.forEach(d => {
                        const checkInDate = d['check-in'];
                        columnsToPlot.forEach(col => {
                            if (!dfTransposed[checkInDate]) {
                                dfTransposed[checkInDate] = {};
                            }
                            dfTransposed[checkInDate][col] = d[col];
                        });
                    });

                    const xScale = d3.scalePoint()
                        .domain(dias_anticipacion)
                        .range([0, innerWidth]);

                    const yScale = d3.scaleLinear()
                        .domain([d3.min(Object.values(dfTransposed), d => d3.min(dias_anticipacion, col => d[col])) - 5, 
                                 d3.max(Object.values(dfTransposed), d => d3.max(dias_anticipacion, col => d[col])) + 5])
                        .range([innerHeight, 0]);

                    const xAxis = d3.axisBottom(xScale);
                    svg.append("g")
                        .attr("transform", `translate(0, ${innerHeight})`)
                        .call(xAxis)
                        .append("text")
                        .attr("x", innerWidth / 2)
                        .attr("y", margin.bottom - 10)
                        .attr("fill", "black")
                        .attr("text-anchor", "middle")
                        .text(xVariable);

                    const yAxis = d3.axisLeft(yScale);
                    svg.append("g")
                        .call(yAxis)
                        .append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("x", -innerHeight / 2)
                        .attr("y", -margin.left + 15)
                        .attr("fill", "black")
                        .attr("text-anchor", "middle")
                        .text(yVariable === "ocupacion" ? "Ocupación (%)" : "Precio");

                    const line = d3.line()
                        .x(d => xScale(d.dia))
                        .y(d => yScale(d.value));

                    Object.keys(dfTransposed).forEach((checkInDate, index) => {
                        const transposedData = dias_anticipacion.map(dia => ({
                            dia: dia,
                            value: dfTransposed[checkInDate][dia],
                            checkInDate: checkInDate 
                        }));

                        svg.append("path")
                            .datum(transposedData)
                            .attr("fill", "none")
                            .attr("stroke", colorScale(index))
                            .attr("stroke-width", 1.5)
                            .attr("d", line);

                        svg.selectAll(".point" + index)
                            .data(transposedData)
                            .enter()
                            .append("circle")
                            .attr("class", "point" + index)
                            .attr("cx", d => xScale(d.dia))
                            .attr("cy", d => yScale(d.value))
                            .attr("r", 4)
                            .style("fill", colorScale(index))
                            .on("mouseover", (event, d) => {
                                tooltip.transition()
                                    .duration(200)
                                    .style("opacity", .9);
                                tooltip.html(`Día de antelación: ${d.dia}<br>Valor: ${d.value}<br>Check-in: ${d3.timeFormat("%Y-%m-%d")(d3.isoParse(d.checkInDate))}`)
                                    .style("left", (event.pageX + 5) + "px")
                                    .style("top", (event.pageY - 28) + "px");
                            })
                            .on("mouseout", () => {
                                tooltip.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                            });
                    });

                    // Mostrar mensaje informativo
                    infoMessage.style.display = "block";
                } else {
                    // Ocultar mensaje informativo
                    infoMessage.style.display = "none";

                    if (chartType === "line") {
                        const xScale = d3.scaleTime()
                            .domain(d3.extent(filteredDataFinal, d => d[xVariable]))
                            .range([0, innerWidth]);

                        const yScale = d3.scaleLinear()
                            .domain([d3.min(filteredDataFinal, d => +d[yVariable]) - 10, d3.max(filteredDataFinal, d => +d[yVariable]) + 1])
                            .range([innerHeight, 0]);

                        const xAxis = d3.axisBottom(xScale);
                        svg.append("g")
                            .attr("transform", `translate(0, ${innerHeight})`)
                            .call(xAxis)
                            .append("text")
                            .attr("x", innerWidth / 2)
                            .attr("y", margin.bottom - 10)
                            .attr("fill", "black")
                            .attr("text-anchor", "middle")
                            .text(xVariable);

                        const yAxis = d3.axisLeft(yScale);
                        svg.append("g")
                            .call(yAxis)
                            .append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("x", -innerHeight / 2)
                            .attr("y", -margin.left + 15)
                            .attr("fill", "black")
                            .attr("text-anchor", "middle")
                            .text(yVariable);

                        const seriesLength = 18;
                        const dataSeries = splitDataIntoSeries(filteredDataFinal, seriesLength);

                        const line = d3.line()
                            .x(d => xScale(d[xVariable]))
                            .y(d => yScale(d[yVariable]));

                        dataSeries.forEach((series, index) => {
                            svg.append("path")
                                .datum(series)
                                .attr("fill", "none")
                                .attr("stroke", colorScale(index))
                                .attr("stroke-width", 1.5)
                                .attr("d", line);

                            svg.selectAll(".point" + index)
                                .data(series)
                                .enter()
                                .append("circle")
                                .attr("class", "point" + index)
                                .attr("cx", d => xScale(d[xVariable]))
                                .attr("cy", d => yScale(d[yVariable]))
                                .attr("r", 4)
                                .style("fill", colorScale(index))
                                .on("mouseover", (event, d) => {
                                    const filtersText = Object.keys(filters)
                                        .filter(filter => filter !== 'tipo' && filter !== 'pax')
                                        .map(filter => `${filter}: ${d[filter]}`).join("<br>");
                                    tooltip.transition()
                                        .duration(200)
                                        .style("opacity", .9);
                                    tooltip.html(`${xVariable}: ${d3.timeFormat("%Y-%m-%d")(d[xVariable])}<br>${yVariable}: ${d[yVariable]}<br>${filtersText}<br>tipo: ${d.tipo}<br>pax: ${d.pax}`)
                                        .style("left", (event.pageX + 5) + "px")
                                        .style("top", (event.pageY - 28) + "px");
                                })
                                .on("mouseout", () => {
                                    tooltip.transition()
                                        .duration(500)
                                        .style("opacity", 0);
                                });
                        });
                    } else if (chartType === "bar") {
                        const MAX_BAR_WIDTH = 100;

                        const xScale = d3.scaleBand()
                            .domain(filteredDataFinal.map(d => d[xVariable]))
                            .range([0, innerWidth])
                            .padding(0.1);

                        const yScale = d3.scaleLinear()
                            .domain([0, d3.max(filteredDataFinal, d => +d[yVariable])])
                            .range([innerHeight, 0]);

                        let xAxis = d3.axisBottom(xScale);

                        if (xVariable === 'check-in') {
                            xAxis = d3.axisBottom(xScale)
                                .tickFormat(d3.timeFormat("%b %d")); // Formatear las fechas como "Abr 18"
                        }

                        svg.append("g")
                            .attr("transform", `translate(0, ${innerHeight})`)
                            .call(xAxis)
                            .append("text")
                            .attr("x", innerWidth / 2)
                            .attr("y", margin.bottom - 10)
                            .attr("fill", "black")
                            .attr("text-anchor", "middle")
                            .text(xVariable);

                        const yAxis = d3.axisLeft(yScale);
                        svg.append("g")
                            .call(yAxis)
                            .append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("x", -innerHeight / 2)
                            .attr("y", -margin.left + 15)
                            .attr("fill", "black")
                            .attr("text-anchor", "middle")
                            .text(yVariable);

                        const barWidth = Math.min((xScale.bandwidth() / filteredDataFinal.length) * 10, MAX_BAR_WIDTH);

                        svg.selectAll(".bar")
                            .data(filteredDataFinal)
                            .enter()
                            .append("rect")
                            .attr("class", "bar")
                            .attr("x", (d, i) => xScale(d[xVariable]) + i * (xScale.bandwidth() / filteredDataFinal.length) + (xScale.bandwidth() / 20 - barWidth / 20))
                            .attr("y", d => yScale(d[yVariable]))
                            .attr("width", barWidth)
                            .attr("height", d => innerHeight - yScale(d[yVariable]))
                            .attr("fill", (d, i) => colorScale(i))
                            .on("mouseover", (event, d) => {
                                const filtersText = Object.keys(filters)
                                    .filter(filter => filter !== 'tipo' && filter !== 'pax')
                                    .map(filter => `${filter}: ${d[filter]}`).join("<br>");
                                tooltip.transition()
                                    .duration(200)
                                    .style("opacity", .9);
                                tooltip.html(`${xVariable}: ${d3.timeFormat("%Y-%m-%d")(d[xVariable])}<br>${yVariable}: ${d[yVariable]}<br>${filtersText}<br>tipo: ${d.tipo}<br>pax: ${d.pax}`)
                                    .style("left", (event.pageX + 5) + "px")
                                    .style("top", (event.pageY - 28) + "px");
                            })
                            .on("mouseout", () => {
                                tooltip.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                            });
                    }
                }
                // Eliminar tooltip al remover el gráfico
                d3.select("#chart-container").on("remove", () => tooltip.remove());
            }

            addFilterButton.addEventListener("click", () => {
                createFilterControl();
            });

            chartTypeSelector.addEventListener("change", () => {
                updateChart();
            });
            xVariableSelector.addEventListener("change", () => {
                if (xVariableSelector.value === "dias de antelacion") {
                    yVariableSelector.innerHTML = "";
                    const ocupacionOption = document.createElement("option");
                    ocupacionOption.value = "ocupacion";
                    ocupacionOption.textContent = "Ocupación";
                    yVariableSelector.appendChild(ocupacionOption);

                    const precioOption = document.createElement("option");
                    precioOption.value = "precio";
                    precioOption.textContent = "Precio";
                    yVariableSelector.appendChild(precioOption);

                    // Disable bar chart option
                    const barOption = document.querySelector("#chart-type-selector option[value='bar']");
                    if (barOption) {
                        barOption.disabled = true;
                    }

                    // Update filter controls to show only 'tipo' and 'pax'
                    filterControls.innerHTML = '';
                    ['tipo', 'pax'].forEach(variable => {
                        const filterContainer = document.createElement("div");
                        filterContainer.className = "filter-container";

                        const filterVariableSelector = document.createElement("select");
                        filterVariableSelector.className = "filter-variable-selector";
                        const filterOption = document.createElement("option");
                        filterOption.value = variable;
                        filterOption.textContent = variable;
                        filterVariableSelector.appendChild(filterOption);

                        const filterValueContainer = document.createElement("div");
                        filterValueContainer.className = "filter-value-container";

                        const noneButton = document.createElement("button");
                        noneButton.className = "filter-none-button";
                        noneButton.textContent = "Ninguno";
                        noneButton.addEventListener("click", () => {
                            filterValueContainer.querySelectorAll('button').forEach(button => {
                                button.classList.remove('selected');
                                button.style.border = "";
                                button.style.color = "";
                            });
                            updateChart();
                        });

                        filterVariableSelector.addEventListener("change", () => {
                            updateFilterValues(filterVariableSelector, filterValueContainer);
                        });

                        filterContainer.appendChild(filterVariableSelector);
                        filterContainer.appendChild(filterValueContainer);
                        filterContainer.appendChild(noneButton);
                        filterControls.appendChild(filterContainer);

                        updateFilterValues(filterVariableSelector, filterValueContainer);
                    });

                    infoMessage.style.display = "block";
                } else {
                    yVariableSelector.innerHTML = "";
                    variables.forEach(variable => {
                        const yOption = document.createElement("option");
                        yOption.value = variable;
                        yOption.textContent = variable;
                        yVariableSelector.appendChild(yOption);

                    });

                    // Enable bar chart option
                    const barOption = document.querySelector("#chart-type-selector option[value='bar']");
                    if (barOption) {
                        barOption.disabled = false;
                    }

                    // Reset filter controls
                    filterControls.innerHTML = '';
                    createFilterControl();

                    infoMessage.style.display = "none";
                }
                updateChart();
            });
            yVariableSelector.addEventListener("change", () => {
                updateChart();
            });

            createFilterControl(); // Crear un filtro inicial por defecto
            updateChart();

            window.addEventListener("resize", updateChart);
        });
    });
</script>
<br>
    <div id="container-sankey" class="container mt-5 mb-5">
        <h1 class="text-center mt-5 mb-5">Diagrama de Sankey: Flujos de Reservas</h1>
        <p class="mt-5 mb-5"> Un Sankey Chart es un tipo de gráfico de flujo que se utiliza para visualizar las transferencias o flujos entre diferentes entidades o nodos. 
            Los nodos están conectados por enlaces cuyas anchuras son proporcionales a la cantidad de flujo que representan. Este tipo de gráfico es útil para mostrar cómo los recursos, como energía, dinero o materiales, se distribuyen.
            <br><br>
            El diagrama de Sankey muestra los flujos de reservas a través de diferentes categorías, como el tipo de alojamiento y la categoría de precios. 
            Este gráfico es útil para entender cómo se distribuyen las reservas en las diferentes categorías, mostrando visualmente el volumen de cada flujo.</p>
        <div class="row justify-content-center">
            <div class="col-12">
                <div style="overflow-x: auto;">
                    <div style="min-width: 1300px;">
                        <svg id="sankey-svg" width="100%" height="700"></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <script>
        const svgS = d3.select("#sankey-svg"),
            widthS = svgS.node().getBoundingClientRect().width,
            heightS = +svgS.attr("height");
    
        const sankey = d3.sankey()
            .nodeWidth(20)
            .nodePadding(20)
            .extent([[1, 1], [widthS - 1, heightS - 1]]);
    
        function categorizePrice(price) {
            price = parseFloat(price);
            if (price < 50) return "Precio Bajo";
            else if (price < 75) return "Precio Medio";
            else if (price < 100) return "Precio Alto";
            else if (price < 125) return "Precio Muy Alto";
            else return "Premium";
        }
    
        d3.csv("../graficas/datos.csv").then(data => {
            const graph = { nodes: [], links: [] };
    
            function getNodeIndex(name) {
                let index = graph.nodes.findIndex(node => node.name === name);
                if (index === -1) {
                    index = graph.nodes.push({ name }) - 1;
                }
                return index;
            }
    
            data.forEach(d => {
                const checkin = `Check-in: ${d['check-in']}`;
                const pax = `Pax: ${d.pax}`;
                const tipo = d.tipo;
                const price = parseFloat(d.precio);
                const priceCategory = categorizePrice(price);
    
                console.log(`Check-in: ${d['check-in']}, Precio: ${price}, Categoría: ${priceCategory}`); 
    
                const checkinIndex = getNodeIndex(checkin);
                const paxIndex = getNodeIndex(pax);
                const tipoIndex = getNodeIndex(tipo);
                const priceIndex = getNodeIndex(priceCategory);
    
                graph.links.push({ source: checkinIndex, target: paxIndex, value: 1 });
                graph.links.push({ source: paxIndex, target: tipoIndex, value: 1 });
                graph.links.push({ source: tipoIndex, target: priceIndex, value: 1 });
            });
    
            sankey(graph);
    
            const color = d3.scaleOrdinal(d3.schemeCategory10);
    
            const link = svgS.append("g").selectAll(".link")
                .data(graph.links)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d3.sankeyLinkHorizontal())
                .style("stroke-width", d => Math.max(1, d.width))
                .style("stroke", d => color(d.source.name))
                .style("fill", "none")
                .style("opacity", 0.5);
    
            link.append("title")
                .text(d => `${d.source.name} → ${d.target.name}\n${d.value}`);
    
            const node = svgS.append("g").selectAll(".node")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x0},${d.y0})`)
                .call(d3.drag()
                    .subject(d => d)
                    .on("start", function () { this.parentNode.appendChild(this); })
                    .on("drag", dragmove));
    
            node.append("rect")
                .attr("height", d => d.y1 - d.y0)
                .attr("width", sankey.nodeWidth())
                .attr("fill", d => color(d.name))
                .append("title")
                .text(d => `${d.name}\n${d.value}`);
    
            node.append("text")
                .attr("x", d => d.x0 < widthS / 2 ? sankey.nodeWidth() + 6 : -6)
                .attr("y", d => (d.y1 - d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < widthS / 2 ? "start" : "end")
                .text(d => d.name)
                .style("font-size", "10px")
                .style("fill", "#000");
    
            function dragmove(event, d) {
                d.y0 = Math.max(0, Math.min(heightS - (d.y1 - d.y0), event.y));
                d.y1 = d.y0 + (d.y1 - d.y0);
                d3.select(this).attr("transform", `translate(${d.x0},${d.y0})`);
                sankey.update(graph);
                link.attr("d", d3.sankeyLinkHorizontal());
            }
        }).catch(error => {
            console.error('Error al cargar los datos:', error);
        });
    </script>
    <br>
    <div id="container-bubble" class="container mt-5 mb-5">
        <h1 class="text-center mt-5 mb-5">Gráfico de Burbujas: Tipo de Alojamiento, Pax y Precio</h1>
        <p class="mt-5 mb-2">
            Un Bubble Chart es una variación del gráfico de dispersión en el que los datos se representan mediante burbujas en lugar de puntos.
            Cada burbuja tiene tres dimensiones de datos: las coordenadas X e Y determinan su posición, y el tamaño de la burbuja representa un tercer valor.
            <br><br>
            El gráfico de burbujas muestra la relación entre el tipo de alojamiento, el número de personas (Pax) y el precio. Cada burbuja representa
            un dato específico, donde su tamaño indica el precio y su posición representa el número de personas y el tipo de alojamiento.
        </p>
        <svg id="bubble-chart" style="width: 100%; height: 700px;"></svg>
        <div class="tooltip" style="opacity: 0;"></div>
    
        <script>
            const marginBubble = { top: 50, right: 50, bottom: 80, left: 80 };
            let widthBubble = document.getElementById('bubble-chart').clientWidth - marginBubble.left - marginBubble.right;
            let heightBubble = 700 - marginBubble.top - marginBubble.bottom;
    
            const svgBubble = d3.select("#bubble-chart")
                .attr("width", widthBubble + marginBubble.left + marginBubble.right)
                .attr("height", heightBubble + marginBubble.top + marginBubble.bottom)
                .append("g")
                .attr("transform", `translate(${marginBubble.left},${marginBubble.top})`);
    
            const tooltipBubble = d3.select(".tooltip");
    
            // Cargar datos desde el archivo CSV
            d3.csv("../graficas/datos.csv").then(data => {
                data.forEach(d => {
                    d.pax = +d.pax;
                    d.precio = +d.precio;
                });
    
                const xBubble = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.pax) * 1.1])
                    .range([0, widthBubble]);
    
                const yBubble = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.precio)])
                    .range([heightBubble, 0]);
    
                const colorBubble = d3.scaleOrdinal()
                    .domain(["Apartamentos", "Hotel"])
                    .range(["#e41a1c", "#4daf4a"]);
    
                const radiusBubble = d3.scaleSqrt()
                    .domain([0, d3.max(data, d => d.precio)])
                    .range([5, 20]);
    
                const bubbles = svgBubble.selectAll(".bubble")
                    .data(data)
                    .enter().append("circle")
                    .attr("class", "bubble")
                    .attr("cx", d => xBubble(d.pax))
                    .attr("cy", d => yBubble(d.precio))
                    .attr("r", d => radiusBubble(d.precio))
                    .style("fill", d => colorBubble(d.tipo))
                    .on("mouseover", (event, d) => {
                        tooltipBubble.transition()
                            .duration(200)
                            .style("opacity", 0.9);
                        tooltipBubble.html(`Tipo: ${d.tipo}<br>Pax: ${d.pax}<br>Precio: ${d.precio.toFixed(2)}`)
                            .style("left", (event.pageX) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", () => {
                        tooltipBubble.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
    
                const xAxisBubble = d3.axisBottom(xBubble).ticks(10);
                const yAxisBubble = d3.axisLeft(yBubble).ticks(10);
    
                svgBubble.append("g")
                    .attr("transform", `translate(0,${heightBubble})`)
                    .call(xAxisBubble)
                    .attr("class", "x-axis");
    
                svgBubble.append("g")
                    .call(yAxisBubble)
                    .attr("class", "y-axis");
    
                svgBubble.append("text")
                    .attr("x", widthBubble / 2)
                    .attr("y", heightBubble + 50)
                    .style("text-anchor", "middle")
                    .text("Número de Personas (Pax)");
    
                svgBubble.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("x", -heightBubble / 2)
                    .attr("y", -60)
                    .style("text-anchor", "middle")
                    .text("Precio");
            }).catch(error => {
                console.error('Error al cargar los datos:', error);
            });
    
            // Ajustar el tamaño del gráfico al cambiar el tamaño de la ventana
            window.addEventListener('resize', () => {
                widthBubble = document.getElementById('bubble-chart').clientWidth - marginBubble.left - marginBubble.right;
                heightBubble = 700 - marginBubble.top - marginBubble.bottom;
    
                const newWidthBubble = document.getElementById('bubble-chart').clientWidth - marginBubble.left - marginBubble.right;
                const newHeightBubble = document.getElementById('bubble-chart').clientHeight - marginBubble.top - marginBubble.bottom;
    
                xBubble.range([0, newWidthBubble]);
                yBubble.range([newHeightBubble, 0]);
    
                d3.select("#bubble-chart")
                    .attr("width", newWidthBubble + marginBubble.left + marginBubble.right)
                    .attr("height", newHeightBubble + marginBubble.top + marginBubble.bottom);
    
                svgBubble.select('.x-axis')
                    .attr("transform", `translate(0,${newHeightBubble})`)
                    .call(xAxisBubble);
    
                svgBubble.select('.y-axis').call(yAxisBubble);
    
                bubbles
                    .attr("cx", d => xBubble(d.pax))
                    .attr("cy", d => yBubble(d.precio))
                    .attr("r", d => radiusBubble(d.precio));
            });
        </script>
    </div>         
    <footer id="footer" class="footer">

        <div class="container">
          <div class="row gy-3">
            <div class="col-lg-3 col-md-6 d-flex">
              <i class="bi bi-geo-alt icon"></i>
              <div>
                <h4>Dirección</h4>
                <p>
                  Dirección: Calle Gran Vía, 123 <br>
                  Granada, Andalucía - España<br>
                </p>
              </div>
      
            </div>
      
            <div class="col-lg-3 col-md-6 footer-links d-flex">
              <i class="bi bi-telephone icon"></i>
              <div>
                <h4>Información</h4>
                <p>
                  <strong>Teléfono:</strong> +34 123 456 789<br>
                  <strong>Email:</strong> info@exploragranada.com<br>
                </p>
              </div>
            </div>
      
            <div class="col-lg-3 col-md-6 footer-links d-flex">
              <i class="bi bi-clock icon"></i>
              <div>
                <h4>Horarios</h4>
                <p>
                  <strong>Lunes-Viernes:</strong> 9AM - 6PM<br>
                  Sábado-Domingo: Cerrado
                </p>
              </div>
            </div>
      
            <div class="col-lg-3 col-md-6 footer-links">
              <h4>Síguenos</h4>
              <div class="social-links d-flex">
                <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
                <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
                <a href="#" class="linkedin">  <i class="bi bi-linkedin"></i></a>
              </div>
            </div>
      
          </div>
        </div>
      
        <div class="container">
          <div class="copyright">
            &copy; Derechos de autor <strong><span>ExploraGranada</span></strong>. Todos los derechos reservados
          </div>
        </div>
    </footer><!-- End Footer -->
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/script.js"></script>
</body>
</html>
